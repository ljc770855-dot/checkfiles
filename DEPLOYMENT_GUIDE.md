# å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Next.js 15 å’Œ Cloudflare Workers çš„å§”æ‰˜æŸ¥è¯¢æœåŠ¡å¹³å°ï¼ŒåŒ…å«å®Œæ•´çš„ç”¨æˆ·è®¤è¯ã€è®¢å•ç®¡ç†ã€æ”¯ä»˜é›†æˆå’Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ã€‚

---

# éƒ¨ç½²æŒ‡å—å’Œé—®é¢˜ä¿®å¤æ€»ç»“

## å·²ä¿®å¤çš„é—®é¢˜

### 1. âœ… Drizzle ORM é…ç½®é—®é¢˜
**é—®é¢˜**: `drizzle.config.ts` ä½¿ç”¨äº†å·²åºŸå¼ƒçš„ `driver: 'd1-http'` é…ç½®
**ä¿®å¤**: æ›´æ–°ä¸ºä½¿ç”¨ `wranglerConfigPath` å’Œ `dbName`

### 2. âœ… æ•°æ®åº“ Schema é»˜è®¤å€¼é—®é¢˜
**é—®é¢˜**: ä½¿ç”¨ `.default(new Date())` åœ¨ SQLite ä¸­ä¸å·¥ä½œ
**ä¿®å¤**: 
- æ”¹ç”¨ `.$defaultFn(() => new Date())` ç”¨äºæ—¶é—´æˆ³
- æ”¹ç”¨ `.$default(() => 'pending')` ç”¨äºå­—ç¬¦ä¸²é»˜è®¤å€¼
- æ·»åŠ  `{ autoIncrement: true }` åˆ°æ‰€æœ‰ä¸»é”®

### 3. âœ… JWT è®¤è¯ Edge Runtime å…¼å®¹æ€§é—®é¢˜
**é—®é¢˜**: `jsonwebtoken` åº“åœ¨ Cloudflare Workers Edge Runtime ä¸­ä¸å…¼å®¹
**ä¿®å¤**: 
- åˆ›å»ºäº†æ–°çš„ `src/lib/jwt.ts` ä½¿ç”¨ Web Crypto API
- æ›´æ–° `src/lib/auth.ts` ä½¿ç”¨æ–°çš„ JWT å®ç°
- æ‰€æœ‰ token ç”Ÿæˆå’ŒéªŒè¯å‡½æ•°æ”¹ä¸ºå¼‚æ­¥

### 4. âœ… Next.js é…ç½®ç¼ºå¤±
**é—®é¢˜**: ç¼ºå°‘ Cloudflare éƒ¨ç½²æ‰€éœ€çš„é…ç½®
**ä¿®å¤**: æ·»åŠ äº†å›¾ç‰‡ä¼˜åŒ–ç¦ç”¨å’Œ serverActions é…ç½®

### 5. âœ… Wrangler é…ç½®æ—¥æœŸé”™è¯¯
**é—®é¢˜**: `compatibility_date` è®¾ç½®ä¸ºæœªæ¥æ—¥æœŸ `2025-03-01`
**ä¿®å¤**: æ›´æ–°ä¸º `2024-10-01`

### 6. âœ… TypeScript ç±»å‹å®šä¹‰ç¼ºå¤±
**é—®é¢˜**: CloudflareEnv æ¥å£ç¼ºå°‘ JWT_SECRET å±æ€§
**ä¿®å¤**: åœ¨ `cloudflare-env.d.ts` ä¸­æ·»åŠ  JWT_SECRET ç±»å‹å®šä¹‰

## éƒ¨ç½²å‰å‡†å¤‡æ¸…å•

### 1. å®‰è£…ä¾èµ–
```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡
ç¡®ä¿ `.env` æˆ– `.dev.vars` æ–‡ä»¶åŒ…å«ä»¥ä¸‹å˜é‡ï¼š
```env
JWT_SECRET=your-strong-secret-key-here
CLOUDFLARE_ACCOUNT_ID=your_account_id
CLOUDFLARE_API_TOKEN=your_api_token
```

### 3. ç¡®è®¤ Cloudflare èµ„æº
ç¡®ä¿ä»¥ä¸‹èµ„æºå·²åœ¨ Cloudflare ä¸­åˆ›å»ºï¼š
- âœ… D1 æ•°æ®åº“: `tianyancha-db` (ID: b4c84633-9d74-4eff-b482-a72c710c6cf5)
- âœ… R2 å­˜å‚¨æ¡¶: `tianyancha-r2`

### 4. ç”Ÿæˆæ•°æ®åº“è¿ç§»
```bash
npm run drizzle:generate
```

### 5. åº”ç”¨æ•°æ®åº“è¿ç§»
```bash
npm run drizzle:migrate
```

### 6. ï¼ˆå¯é€‰ï¼‰å¡«å……åˆå§‹æ•°æ®
```bash
npm run db:seed
```

## æœ¬åœ°æµ‹è¯•

### å¼€å‘æ¨¡å¼
```bash
npm run dev
```
è®¿é—® http://localhost:3000

### é¢„è§ˆ Cloudflare éƒ¨ç½²
```bash
npm run preview
```

## éƒ¨ç½²åˆ° Cloudflare Workers

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ npm è„šæœ¬
```bash
npm run deploy
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²
```bash
npx opennextjs-cloudflare build
npx opennextjs-cloudflare deploy
```

## éƒ¨ç½²åé…ç½®

### 1. è®¾ç½® Cloudflare Secrets
åœ¨ Cloudflare Dashboard ä¸­è®¾ç½®ä»¥ä¸‹ secretsï¼š
```bash
wrangler secret put JWT_SECRET
```

### 2. éªŒè¯ç»‘å®š
ç¡®ä¿ Worker å·²æ­£ç¡®ç»‘å®šï¼š
- D1 æ•°æ®åº“ (binding: DB)
- R2 å­˜å‚¨æ¡¶ (binding: R2)

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: æ•°æ®åº“è¿æ¥å¤±è´¥
**æ£€æŸ¥**:
- D1 æ•°æ®åº“ ID æ˜¯å¦æ­£ç¡®
- æ•°æ®åº“è¿ç§»æ˜¯å¦å·²åº”ç”¨
- wrangler.jsonc ä¸­çš„ç»‘å®šé…ç½®æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 2: JWT Token éªŒè¯å¤±è´¥
**æ£€æŸ¥**:
- JWT_SECRET ç¯å¢ƒå˜é‡æ˜¯å¦å·²è®¾ç½®
- Token æ ¼å¼æ˜¯å¦æ­£ç¡® (Bearer token)
- Token æ˜¯å¦è¿‡æœŸ (é»˜è®¤ 7 å¤©)

### é—®é¢˜ 3: æ–‡ä»¶ä¸Šä¼ å¤±è´¥
**æ£€æŸ¥**:
- R2 å­˜å‚¨æ¡¶åç§°æ˜¯å¦æ­£ç¡®
- R2 ç»‘å®šæ˜¯å¦æ­£ç¡®é…ç½®
- æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶ (10MB)

### é—®é¢˜ 4: æœ¬åœ°å¼€å‘æ— æ³•è¿æ¥æ•°æ®åº“
**è§£å†³æ–¹æ¡ˆ**:
æœ¬åœ°å¼€å‘éœ€è¦ä½¿ç”¨ wrangler çš„æœ¬åœ°æ¨¡å¼ï¼š
```bash
# ä½¿ç”¨ wrangler dev è€Œä¸æ˜¯ next dev
wrangler dev
```

æˆ–è€…é…ç½®æœ¬åœ° D1 æ•°æ®åº“ï¼š
```bash
wrangler d1 create tianyancha-db-local
```

## ä»£ç æ”¹è¿›å»ºè®®

### 1. å®‰å…¨æ€§å¢å¼º
- [ ] åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼º JWT_SECRET
- [ ] æ·»åŠ è¯·æ±‚é€Ÿç‡é™åˆ¶
- [ ] å®ç° CSRF ä¿æŠ¤
- [ ] æ·»åŠ è¾“å…¥éªŒè¯å’Œæ¸…ç†

### 2. æ€§èƒ½ä¼˜åŒ–
- [ ] å¯ç”¨ R2 ç¼“å­˜ (åœ¨ open-next.config.ts ä¸­)
- [ ] æ·»åŠ æ•°æ®åº“æŸ¥è¯¢ç´¢å¼•
- [ ] å®ç° API å“åº”ç¼“å­˜

### 3. é”™è¯¯å¤„ç†
- [ ] æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- [ ] å®ç°ç»“æ„åŒ–æ—¥å¿—è®°å½•
- [ ] æ·»åŠ é”™è¯¯ç›‘æ§ (å¦‚ Sentry)

### 4. åŠŸèƒ½å®Œå–„
- [ ] æ·»åŠ ç”¨æˆ·è§’è‰²å’Œæƒé™ç³»ç»Ÿ
- [ ] å®ç°è®¢å•çŠ¶æ€æ›´æ–° API
- [ ] æ·»åŠ æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
- [ ] å®ç°è®¢å•æŸ¥è¯¢å’Œç­›é€‰

## æŠ€æœ¯æ ˆç‰ˆæœ¬

- Next.js: 15.4.6
- React: 19.1.0
- Drizzle ORM: 0.44.6
- Wrangler: 4.42.0
- @opennextjs/cloudflare: 1.3.0

## æ³¨æ„äº‹é¡¹

1. **ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯**
2. **å®šæœŸæ›´æ–°ä¾èµ–åŒ…**ä»¥è·å–å®‰å…¨è¡¥ä¸
3. **åœ¨éƒ¨ç½²å‰è¿›è¡Œå……åˆ†æµ‹è¯•**
4. **å¤‡ä»½æ•°æ®åº“**åœ¨è¿›è¡Œé‡å¤§æ›´æ”¹å‰
5. **ç›‘æ§ Cloudflare Workers ä½¿ç”¨é‡**ä»¥é¿å…è¶…å‡ºé…é¢

## ğŸ¯ æ–°å¢åŠŸèƒ½è¯´æ˜

### æ”¯ä»˜åŠŸèƒ½
- âœ… æ˜“æ”¯ä»˜é›†æˆ
- âœ… æ”¯æŒæ”¯ä»˜å®ã€å¾®ä¿¡ã€QQé’±åŒ…
- âœ… å¼‚æ­¥æ”¯ä»˜å›è°ƒå¤„ç†
- âœ… æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢

### è®¢å•ç®¡ç†
- âœ… ç”¨æˆ·è®¢å•åˆ—è¡¨å’Œè¯¦æƒ…
- âœ… ç®¡ç†å‘˜è®¢å•ç®¡ç†
- âœ… è®¢å•çŠ¶æ€æ›´æ–°
- âœ… æ–‡ä»¶ä¸Šä¼ å’Œè®¿é—®

### åœ¨çº¿å®¢æœ
- âœ… æ”¯æŒç¬¬ä¸‰æ–¹å®¢æœ SDK é›†æˆ
- âœ… æ¨èä½¿ç”¨ç¾æ´½ã€æ™ºé½¿ç­‰æœåŠ¡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [API æ–‡æ¡£](./API_DOCUMENTATION.md) - å®Œæ•´çš„ API æ¥å£æ–‡æ¡£
- [Cloudflare Workers æ–‡æ¡£](https://developers.cloudflare.com/workers/)
- [OpenNext.js Cloudflare æ–‡æ¡£](https://opennext.js.org/cloudflare)
- [Drizzle ORM æ–‡æ¡£](https://orm.drizzle.team/)
- [Next.js æ–‡æ¡£](https://nextjs.org/docs)

## ğŸ”„ æ•°æ®åº“è¿ç§»

ç”±äºæ·»åŠ äº†æ”¯ä»˜ç›¸å…³å­—æ®µï¼Œéœ€è¦é‡æ–°ç”Ÿæˆå’Œåº”ç”¨æ•°æ®åº“è¿ç§»ï¼š

```bash
# ç”Ÿæˆæ–°çš„è¿ç§»
npm run drizzle:generate

# åº”ç”¨è¿ç§»åˆ°è¿œç¨‹æ•°æ®åº“
npx wrangler d1 execute tianyancha-db --file=src/drizzle/migrations/[æ–°ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶].sql --remote
```

## ğŸ¨ å‰ç«¯é¡µé¢

é¡¹ç›®åŒ…å«ä¸¤ä¸ªç‹¬ç«‹çš„å‰ç«¯é¡µé¢ï¼š
- `public/client.html` - å®¢æˆ·ç«¯é¡µé¢ï¼ˆç”¨æˆ·ä¸‹å•ã€æŸ¥çœ‹è®¢å•ï¼‰
- `public/admin.html` - ç®¡ç†åå°ï¼ˆç®¡ç†å‘˜ç®¡ç†è®¢å•ï¼‰

è¿™äº›é¡µé¢å¯ä»¥ç›´æ¥è®¿é—®ï¼Œæ— éœ€æ„å»ºã€‚
